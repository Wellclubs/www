<?phpclass PageAdmCmps{ const TABLE = WDsc::TABLE_CAMPAIGN; private static function processAct($act) {  $table = self::TABLE;  $entity = 'campaign';  switch ($act)  {  case 'createEntity' :   PageAdm::createEntity($table, $entity, null, array   (     'creator_id' => Util::nvls(WClient::id(), 1),     'domain_id' => WDomain::id(),     'currency_id' => DB::str(WDomain::currencyId()),     'start_date' => DB::str(DB::date2str(new DateTime()))   ), null, array('noname' => true, 'noserial' => true));   break;  case 'deleteEntity' :   PageAdm::deleteEntity($table, $entity);   break;  case 'changeFlag' :   $flag = HTTP::param('flag');   $flags = array('A' => 'active');   $field = Util::item($flags, $flag);   $_REQUEST[$field] = HTTP::param('value') ? 'Y' : 'N';   PageAdm::changeField($table, $entity, $field);   break;  case 'changeField' :   if (fnmatch('*_date', HTTP::get('field')))    $_REQUEST['value'] = DB::date2str(Util::str2date($_REQUEST['value']));   PageAdm::changeField($table, $entity);   break;  default :   echo "Unsupported action: '$act'";  }  return true; } public static function showPage() {  if (is_null(WDomain::id()))  {   echo "Unknown domain: " . WDomain::name();   exit;  }  if (array_key_exists('act', $_REQUEST))  {   if (self::processAct($_REQUEST['act']))    exit;  }?><!doctype html><html><head><?php PageAdm::instance()->showTitle(); ?><style type="text/css">table.main th.title { text-align:left;padding:0 5px; }table.main th a { display:block; }</style><script>var entity='campaign';function createEntity(){ A.createEntity(entity,null,null,true);}function deleteEntity(id){ A.deleteEntity(id,entity);}function changeFlag(node,id,flag){ var name={'A':'Active'}[flag]; var oldValue=(node.className=='checked'); var flagTitle='the flag "'+name+'" for '+entity+' '+id; var text=(oldValue?'Reset ':'Set ')+flagTitle; if(!confirm(text+'?'))  return; var value=oldValue?'':'1'; var req=new XMLHttpRequest(); req.open("GET",document.location+'?act=changeFlag&id='+id+'&flag='+flag+'&value='+value,false); req.send(null); var error='Error changing '+flagTitle+' on the server'; if (req.status!=200)  return alert(error); if (req.responseText!='OK')  return alert(error+': '+req.responseText); node.className=oldValue?'':'checked';}function changeField(node,id,field){ A.changeField(node,id,entity,field);}</script></head><?php PageAdm::instance()->showBodyTop(); ?><table class="main text" cellspacing="0" cellpadding="0"><caption><?php echo PageAdm::title();?></caption><tr><th width='100'>Id</th><th width='400'>Reference</th><th width='50'>Cur.</th><th width='100'>Start date</th><th width='100'>Dsc amount</th><th width='100'>Min value</th><th width='100'>Dsc percent</th><th width='1'><input type='button' value='Create new' onclick='createEntity()'/></th></tr><tr><th>Event</th><th>Created/Creator</th><th>Active</th><th>Expiry date</th><th>Bgt limit</th><th>Max value</th><th>Max rdns</th><th>Rdn days</th></tr><?php$fields = 'id,event,ref,created,creator_id,currency_id,active,start_date,expiry_date,' .  'evnt_dsc_amnt,bdgt_lmt,min_vle,max_vle,evnt_dsc_prcnt,max_rdmptns,rdmptn_durtn,art_pay_dsc_dscrptn';$where = 'domain_id=' . WDomain::id();$order = 'id desc';$records = PageAdm::db()->queryArrays(self::TABLE, $fields, $where, $order);if ($records){ foreach ($records as $record) {  $id = $record['id'];  $ref = $record['ref'];  $event = $record['event'];  $created = $record['created'];  $creator_id = $record['creator_id'];  $creator_title = PageAdm::makeEntityText($creator_id, WClient::getClientName($creator_id));  //$creator_title = DB::lastQuery();  $currency_id = $record['currency_id'];  $active = $record['active'] == 'Y';  $start_date = Util::date2str(DB::str2date($record['start_date']));  $expiry_date = Util::date2str(DB::str2date($record['expiry_date']));  $evnt_dsc_amnt = DB::ints($record['evnt_dsc_amnt']);  $bdgt_lmt = DB::ints($record['bdgt_lmt']);  $min_vle = DB::ints($record['min_vle']);  $max_vle = DB::ints($record['max_vle']);  $evnt_dsc_prcnt = DB::ints($record['evnt_dsc_prcnt']);  $max_rdmptns = DB::ints($record['max_rdmptns']);  $rdmptn_durtn = DB::ints($record['rdmptn_durtn']);  $art_pay_dsc_dscrptn = $record['art_pay_dsc_dscrptn'];  echo "<tr>\n";  echo "<th class='right'>$id</th>\n";  echo "<th class='center'>$ref</th>\n";  echo "<td class='center' onclick='changeField(this,$id,\"currency_id\")'>$currency_id</td>\n";  echo "<td class='center' onclick='changeField(this,$id,\"start_date\")'>$start_date</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"evnt_dsc_amnt\")'>$evnt_dsc_amnt</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"min_vle\")'>$min_vle</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"evnt_dsc_prcnt\")'>$evnt_dsc_prcnt</td>\n";  echo "<td><input style='width:100%' type='button' value='Delete' onclick='deleteEntity($id)'/></td>\n";  echo "</tr>\n";  echo "<tr>\n";  echo "<td class='left' onclick='changeField(this,$id,\"event\")'>$event</td>\n";  echo "<th class='left'>$created, $creator_title</th>\n";  echo "<td" . ($active ? " class='checked'" : null) . " onclick='changeFlag(this,$id,\"A\")'></td>\n";  echo "<td class='center' onclick='changeField(this,$id,\"expiry_date\")'>$expiry_date</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"bdgt_lmt\")'>$bdgt_lmt</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"max_vle\")'>$max_vle</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"max_rdmptns\")'>$max_rdmptns</td>\n";  echo "<td class='right' onclick='changeField(this,$id,\"rdmptn_durtn\")'>$rdmptn_durtn</td>\n";  echo "</tr>\n";  echo "<tr><td class='text' colspan='8'>";  PageAdm::echoTextArea("desc-$id", $art_pay_dsc_dscrptn, "notification", 'changeField', 'value', "id=$id&field=art_pay_dsc_dscrptn", 5);  echo "</td></tr>\n"; }}?></table></body></html><?phpreturn true; }}?>